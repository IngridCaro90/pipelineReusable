name: api-historical-events

on:
  workflow_call:
    inputs:
      MONTH:
        description: 'Ingrese el número del mes (01-12)'
        required: true
        type: string
      DAY:
        description: 'Ingrese el número del día (01-31)'
        required: true
        type: string

jobs:
  fetch-events:
    name: Fetch historical events from cached response API
    runs-on: ubuntu-latest
    outputs:
      events-list: ${{ steps.consult-json.outputs.events }}
      events-count: ${{ steps.consult-json.outputs.events_count }}

    steps:
      - name: Restore cache
        id: cache-restored
        uses: actions/cache/restore@v4
        with:
          path: response.json
          key: ${{ runner.os }}-${{ vars.LANG }}-${{ inputs.MONTH }}-${{ inputs.DAY }}

      - name: Fetch historical events from API response (Only if not cached)
        id: response-api
        if: steps.cache-restored.outputs.cache-hit != 'true'
        run: |
          curl -s "https://api.wikimedia.org/feed/v1/wikipedia/${{ vars.LANG }}/onthisday/selected/${{ inputs.MONTH }}/${{ inputs.DAY }}" -o response.json
          echo "file=response.json" >> $GITHUB_OUTPUT
          echo "API response fetched and saved to file."

      - name: Compute hash
        id: compute_hash
        run: |
          echo "hash=$(echo -n '${{ vars.LANG }}-${{ inputs.MONTH }}-${{ inputs.DAY }}' | sha256sum | cut -d ' ' -f1)" >> $GITHUB_OUTPUT

      - name: Save response.json to cache
        uses: actions/cache/save@v4
        with:
          path: response.json
          key: ${{ runner.os }}-${{ vars.LANG }}-${{ inputs.MONTH }}-${{ inputs.DAY }}

      - name: Substract events from response.json
        id: consult-json
        run: |
          if [ -s response.json ]; then
            if jq empty response.json 2>/dev/null; then
              COUNT=$(jq '.selected | length' response.json)
              if [ "$COUNT" -eq 0 ]; then
                echo "Don't find events for the ${{ inputs.MONTH }}/${{ inputs.DAY }}."
                echo "events=[]" >> $GITHUB_OUTPUT
                echo "events_count=0" >> $GITHUB_OUTPUT
              else
                jq -c '[.selected[] | {title: .pages[0].title, url: .pages[0].content_urls.desktop.page}]' response.json > events_list.json
                EVENTS=$(cat events_list.json)
                echo "Se encontraron $COUNT eventos."
                echo "events=$EVENTS" >> $GITHUB_OUTPUT
                echo "events_count=$COUNT" >> $GITHUB_OUTPUT
              fi
            else
              echo "response.json no contiene JSON válido."
              echo "events=[]" >> $GITHUB_OUTPUT
              echo "events_count=0" >> $G_
